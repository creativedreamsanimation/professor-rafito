<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3B82F6">
    <meta name="description" content="As Aventuras do Professor Rafito - Histórias educativas para crianças">
    <title>Professor Rafito - Histórias Educativas</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%233B82F6'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='%23FFFFFF'>R</text></svg>">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" as="script">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" as="script">
    <link rel="preload" href="https://unpkg.com/@babel/standalone/babel.min.js" as="script">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <noscript>
        <style>
            #root, #install-prompt, #offline-indicator { display: none !important; }
            body::before {
                content: "Este aplicativo requer JavaScript para funcionar corretamente.";
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: red;
                color: white;
                text-align: center;
                padding: 1rem;
                z-index: 9999;
            }
        </style>
    </noscript>
</head>
<body>
    <div id="root"></div>

    <!-- PWA Install Button -->
    <div id="install-prompt" style="display: none; position: fixed; top: 20px; right: 20px; background: #3B82F6; color: white; padding: 12px 16px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; font-family: sans-serif; cursor: pointer;">
        📱 Instalar App
    </div>

    <!-- Offline Indicator -->
    <div id="offline-indicator" style="display: none; position: fixed; top: 20px; left: 20px; background: #EF4444; color: white; padding: 8px 12px; border-radius: 8px; font-family: sans-serif; z-index: 1000; font-size: 14px;">
        🔌 Modo Offline
    </div>

    <script type="text/babel">
        // Seu código React permanece exatamente o mesmo
        const { useState, useEffect } = React;
        const { 
            Book, Zap, Star, Heart, ArrowLeft, ArrowRight, 
            Sparkles, Save, Library, Home, Trash2, Play 
        } = lucide;

        const StoryGenerator = () => {
            // ... (todo o restante do seu código React permanece igual)
        };

        ReactDOM.render(<StoryGenerator />, document.getElementById('root'));
    </script>

    <script>
        // Service Worker Registration - Versão Corrigida
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'rafito-pwa-v2';
                const ASSETS_TO_CACHE = [
                    '/',
                    'index.html',
                    'https://cdn.tailwindcss.com/',
                    'https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js',
                    'https://unpkg.com/@babel/standalone/babel.min.js',
                    'https://unpkg.com/lucide@latest/dist/umd/lucide.js'
                ];

                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => cache.addAll(ASSETS_TO_CACHE))
                            .then(() => self.skipWaiting())
                    );
                });

                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => response || fetch(event.request))
                    );
                });

                self.addEventListener('activate', event => {
                    event.waitUntil(
                        caches.keys().then(cacheNames => {
                            return Promise.all(
                                cacheNames.map(cacheName => {
                                    if (cacheName !== CACHE_NAME) {
                                        return caches.delete(cacheName);
                                    }
                                })
                            );
                        })
                    );
                    self.clients.claim();
                });
            `;

            window.addEventListener('load', () => {
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Falha no registro do Service Worker:', error);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        const installButton = document.getElementById('install-prompt');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'block';
            
            installButton.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        console.log('Usuário aceitou a instalação');
                    }
                    deferredPrompt = null;
                    installButton.style.display = 'none';
                }
            });
        });

        window.addEventListener('appinstalled', () => {
            installButton.style.display = 'none';
            console.log('PWA instalado com sucesso');
        });

        // Check if running as PWA
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('Executando como PWA instalado');
            installButton.style.display = 'none';
        }

        // Online/Offline detection
        window.addEventListener('online', () => {
            document.getElementById('offline-indicator').style.display = 'none';
        });

        window.addEventListener('offline', () => {
            document.getElementById('offline-indicator').style.display = 'block';
        });

        // Initial online status check
        if (!navigator.onLine) {
            document.getElementById('offline-indicator').style.display = 'block';
        }

        // Add bounce animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes bounce {
                0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                40% { transform: translateY(-5px); }
                60% { transform: translateY(-3px); }
            }
            #install-prompt {
                animation: bounce 1s infinite;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>